<?xml version="1.0"?>

<project default = "build" basedir="." name="retsdb2">

  <!-- set global properties for this build -->
  <property name="project.name" value="retsdb2"/>
  <property name="project.version" value="0.0.1"/>
  <property name="project.string" value="${project.name}-${project.version}"/>

  <!-- This must be done before any other propertes -->
  <property file="${basedir}/build.properties" />
  <property file="${user.home}/.build.properties" />

  <fileset id="hibernate.mapping.files" dir="project/hibernate/mappings">
    <include name="**/*.hbm.xml" />
  </fileset>

  <!-- The following properties may be overriden by the user -->
  <property name="compile.optimize" value="off"/>
  <property name="compile.debug" value="on"/>
  <property name="compile.deprecation" value="off"/>
  <property name="hibernate.schema.text.only" value="yes"/>
  <property name="hibernate.schema.quiet" value="yes"/>

  <path id="hibernate.path">
    <pathelement path="${commons-lang.jar}"/>
    <pathelement path="${hibernate.jar}"/>
  </path>

  <path id="lib.path">
    <pathelement path="${hibernate.jar}"/>
    <pathelement path="${hibernate.jdbc.jar}"/>
    <fileset dir="${hibernate.lib}" includes="*.jar"/>
    <pathelement path="${hibernate-ext.tools.jar}"/>
    <pathelement path="${jdom.jar}"/>
  </path>

  <path id="embedded.path">
    <fileset dir="${tomcat.home}/server/lib" includes="*.jar"/>
  </path>

  <path id="importer.path">
    <pathelement location="${rets-client.jar}"/>
    <pathelement path="build/hibernate/classes"/>
  </path>

  <path id="webapp.path">
    <pathelement path="${servlet.jar}"/>
    <pathelement path="${log4j.jar}"/>
    <pathelement path="${commons-lang.jar}"/>
    <pathelement location="build/embedded/classes"/>
  </path>

  <path id="xdoclet.path">
    <pathelement path="${ant.home}/lib/ant.jar" />
    <fileset dir="${xdoclet.lib}" includes="commons-*.jar"/>
    <pathelement location="${xdoclet.jar}"/>
    <pathelement location="${xdoclet.xdoclet.jar}"/>
    <pathelement location="${xjavadoc.jar}"/>
  </path>

  <!-- Add the checkstyle task -->
<!--   <taskdef name="checkstyle" -->
<!--            classname="com.puppycrawl.tools.checkstyle.CheckStyleTask"> -->
<!--     <classpath> -->
<!--       <pathelement path="${checkstyle.jar}" /> -->
<!--     </classpath> -->
<!--   </taskdef> -->

  <target name="build-properties-check">
    <condition property="build.properties.uptodate">
      <and>
        <available file="build.properties" />
        <available file="project/build.properties" />
        <uptodate targetfile="build.properties">
          <srcfiles dir="project" includes="build.properties" />
        </uptodate>
      </and>
    </condition>
  </target>

  <target name="build-properties-up-to-date"
          unless="build.properties.uptodate"
          depends="build-properties-check">
    <fail message="build.properties is out of date or missing." />
  </target>

  <target name="prepare" depends="build-properties-up-to-date">
    <mkdir dir="build/hibernate/final/classes"/>
    <mkdir dir="build/hibernate/generated"/>
    <mkdir dir="build/hibernate/schema"/>
    <mkdir dir="build/hibernate/jar"/>
    <mkdir dir="build/hibernate/classes"/>
    <mkdir dir="build/hibernate/doc"/>
    <mkdir dir="build/embedded/classes"/>
    <mkdir dir="build/importer/classes"/>
    <mkdir dir="build/importer/lib"/>
    <mkdir dir="build/importer/bin"/>
    <mkdir dir="build/rets-server/lib"/>
    <mkdir dir="build/rets-server/webapp/WEB-INF/classes"/>
    <mkdir dir="build/rets-server/webapp/WEB-INF/lib"/>
    <mkdir dir="build/webapp/test/classes"/>
    <mkdir dir="dist" />
  </target>

  <target name="build" depends="build-hibernate,build-webapp,build-importer"
          description="Build all"/>

  <target name="dist" depends="generate-schema" />

  <target name="build-hibernate" depends="prepare">
    <taskdef name="hibernatedoclet"
             classname="xdoclet.modules.hibernate.HibernateDocletTask">
      <classpath>
        <path refid="xdoclet.path"/>
        <path location="${xdoclet.hibernate.jar}"/>
      </classpath>
    </taskdef>
    <hibernatedoclet destdir="build/hibernate/xdoclet" verbose="true"
                     mergedir="project/hibernate/java">
      <fileset dir="project/hibernate/java" includes="**/*.java"/>
      <hibernate version="2.0"/>
    </hibernatedoclet>
    <javac srcdir="project/hibernate/java"
           destdir="build/hibernate/classes"
           optimize="${compile.optimize}"
           debug="${compile.debug}"
           deprecation="${compile.deprecation}">
      <classpath>
        <path refid="hibernate.path" />
      </classpath>
    </javac>
    <jar destfile="build/hibernate/jar/${project.name}-hibernate.jar"
         basedir="build/hibernate/classes"
         excludes="hibernate.properties" index="true"/>
    <jar destfile="build/hibernate/jar/${project.name}-hbm-xml.jar"
         basedir="build/hibernate/xdoclet" index="true"/>
  </target>

  <target name="build-hibernate-xschema" depends="build-hibernate">
    <taskdef name="schemaexport"
             classname="net.sf.hibernate.tool.hbm2ddl.SchemaExportTask">
      <classpath>
        <path refid="lib.path"/>
        <pathelement path="build/hibernate/classes"/>
      </classpath>
    </taskdef>

    <schemaexport properties="project/hibernate/config/hibernate.properties"
                  quiet="${hibernate.schema.quiet}"
                  text="${hibernate.schema.text.only}"
                  drop="no" delimiter=";"
                  output="build/hibernate/schema/xschema-export.sql">
      <fileset dir="build/hibernate/xdoclet">
        <include name="**/*.hbm.xml"/>
      </fileset>
    </schemaexport>
  </target>

  <target name="build-hibernate-old" depends="build-generated-code,build-xml">
    <jar destfile="build/hibernate/jar/${project.name}-hibernate.jar"
         basedir="build/hibernate/final/classes"
         excludes="hibernate.properties" index="true"/>
  </target>

  <target name="doc" depends="build-generated-code,prepare">
    <javadoc packagenames="org.realtors.rets.*"
             destdir="build/doc/api"
             author="true"
             version="true"
             use="true"
             windowtitle="Retzilla API"
             private="${javadoc.private}"
             doctitle="Retzilla API">
      <link offline="true"
            href="http://java.sun.com/j2se/1.3/docs/api/"
            packageListLoc="${javadoc.1.3.local}"/>
      <sourcepath>
        <pathelement location="project/embedded/java"/>
        <pathelement location="project/hibernate/java/enums"/>
        <pathelement location="project/importer/java"/>
        <pathelement location="project/webapp/java"/>
        <pathelement location="build/hibernate/generated"/>
      </sourcepath>
      <classpath>
        <path refid="lib.path"/>
        <path refid="embedded.path"/>
        <path refid="importer.path"/>
      </classpath>
    </javadoc>
  </target>

  <target name="build-embedded" depends="prepare">
    <depend srcDir="project/embedded/java"
            destDir="build/embedded/classes"
            cache="build/embedded/depcache" closure="yes">
      <classpath>
        <path refid="embedded.path" />
      </classpath>
    </depend>
    <javac srcdir="project/embedded/java"
           destdir="build/embedded/classes"
           optimize="${compile.optimize}"
           debug="${compile.debug}"
           deprecation="${compile.deprecation}">
      <classpath>
        <path refid="embedded.path" />
      </classpath>
    </javac>

    <jar jarfile="build/rets-server/lib/rets-server.jar"
         basedir="build/embedded/classes"
         manifest="project/build/rets-server.manifest"/>
    <copy todir="build/rets-server/lib">
      <fileset dir="${tomcat.home}/bin">
        <include name="bootstrap.jar"/>
      </fileset>
    </copy>
    <copy todir="build/rets-server/lib">
      <fileset dir="${tomcat.home}/common/lib">
        <include name="servlet.jar"/>
        <include name="naming-common.jar"/>
        <include name="naming-resources.jar"/>
        <include name="commons-collections.jar"/>
      </fileset>
    </copy>
    <copy todir="build/rets-server/lib">
      <fileset dir="${tomcat.home}/server/lib">
        <include name="catalina.jar"/>
        <include name="commons-digester.jar"/>
        <include name="tomcat-coyote.jar"/>
        <include name="tomcat-util.jar"/>
        <include name="tomcat-http11.jar"/>
        <include name="commons-logging.jar"/>
        <include name="commons-beanutils.jar"/>
        <include name="servlets-common.jar"/>
        <include name="servlets-default.jar"/>
      </fileset>
    </copy>
    <copy tofile="build/rets-server/lib/log4j.jar" file="${log4j.jar}"/>
  </target>

  <target name="build-webapp-webdoclet">
    <taskdef name="webdoclet" classname="xdoclet.modules.web.WebDocletTask">
      <classpath>
        <path refid="xdoclet.path"/>
        <path location="${xdoclet.web.jar}"/>
        <pathelement location="${servlet.jar}"/>
      </classpath>
    </taskdef>
    <webdoclet destdir="build/webapp/generated" verbose="false">
      <fileset dir="project/webapp/java"/>

      <deploymentdescriptor servletspec="2.3"
                            destdir="build/rets-server/webapp/WEB-INF"
                            sessiontimeout="30"
                            mergedir="project/webapp/config/web-merge"
                            displayname="CRT RETS Server"
                            description="CRT RETS Server">
      </deploymentdescriptor>
    </webdoclet>
  </target>

  <target name="build-webapp" depends="build-hibernate,build-embedded"
          description="Build webapp">
    <depend srcDir="project/webapp/java"
            destDir="build/rets-server/webapp/WEB-INF/classes"
            cache="build/depcache" closure="yes">
      <classpath>
        <path refid="webapp.path"/>
      </classpath>
    </depend>
    <javac srcdir="project/webapp/java"
           destdir="build/rets-server/webapp/WEB-INF/classes"
           optimize="${compile.optimize}" debug="${compile.debug}"
           deprecation="${compile.deprecation}">
      <classpath>
        <path refid="webapp.path"/>
      </classpath>
    </javac>

    <depend srcDir="project/webapp/test/java"
            destDir="build/webapp/test/classes"
            cache="build/depcache" closure="yes">
      <classpath>
        <path refid="webapp.path"/>
        <pathelement location="build/rets-server/webapp/WEB-INF/classes"/>
      </classpath>
    </depend>
    <javac srcdir="project/webapp/test/java"
            destDir="build/webapp/test/classes"
           optimize="${compile.optimize}" debug="${compile.debug}"
           deprecation="${compile.deprecation}">
      <classpath>
        <path refid="webapp.path"/>
        <pathelement location="build/rets-server/webapp/WEB-INF/classes"/>
      </classpath>
    </javac>

    <copy todir="build/rets-server/webapp">
      <fileset dir="project/webapp/content" includes="**/*"/>
    </copy>

    <copy todir="build/rets-server/webapp/WEB-INF/classes">
      <fileset dir="project/webapp/java" includes="**/*" excludes="**/*.java"/>
    </copy>

    <antcall target="build-webapp-webdoclet"/>
    <copy todir="build/rets-server/conf">
      <fileset dir="project/embedded/config" includes="*"/>
    </copy>
    <copy file="project/webapp/config/tomcat-users.xml"
          todir="build/rets-server/conf"/>
    <copy todir="build/rets-server/webapp/WEB-INF/lib"
          file="build/hibernate/jar/${project.name}-hibernate.jar"/>
    <copy todir="build/rets-server/webapp/WEB-INF/lib"
          file="${commons-lang.jar}"/>
  </target>

  <target name="build-importer" depends="build-hibernate"
          description="Builds the data and metadata importers">
    <depend srcDir="project/importer/java"
            destDir="build/importer/classes"
            cache="build/importer/depcache" closure="yes">
      <classpath>
        <path refid="lib.path"/>
        <path refid="importer.path"/>
      </classpath>
    </depend>
    <javac srcdir="project/importer/java"
           destdir="build/importer/classes"
           optimize="${compile.optimize}" debug="${compile.debug}"
           deprecation="${compile.deprecation}">
      <classpath>
        <path refid="lib.path"/>
        <path refid="importer.path"/>
      </classpath>
    </javac>

    <copy file="project/importer/shell/runImporter"
          todir="build/importer/bin"/>
    <chmod file="build/importer/bin/runImporter" perm="ugo+rx"/>
    <copy file="${rets-client.jar}" todir="build/importer/lib"/>
    <copy file="${commons-lang.jar}" todir="build/importer/lib"/>
    <copy file="${httpclient.jar}" todir="build/importer/lib"/>
    <copy file="${commons-logging.jar}" todir="build/importer/lib"/>
    <copy file="${rets-client.jar}" todir="build/importer/lib"/>
    <copy file="${log4j.jar}" todir="build/importer/lib"/>
    <copy file="${jdom.jar}" todir="build/importer/lib"/>
    <copy file="build/hibernate/jar/${project.name}-hibernate.jar"
          todir="build/importer/lib"/>
    <copy file="build/hibernate/jar/${project.name}-hbm-xml.jar"
          todir="build/importer/classes"/>

    <!-- this copies the hibernate stuff we need -->
    <copy todir="build/importer/lib">
      <fileset dir="${hibernate.lib}" includes="*.jar"
               excludes="j2ee.jar,xerces.jar,ant.jar,junit.jar,jaas.jar" />
    </copy>
    <copy todir="build/importer/lib"
          file="${hibernate.jar}"/>
    <copy todir="build/importer/classes"
          file="project/hibernate/config/hibernate.properties"/>
<!--     <copy todir="build/importer/lib" -->
<!--           file="code/hibernate/config/hibernate.properties.dist"/> -->

    <!-- Oh yeah, the jdbc driver would be nice. -->
    <copy todir="build/importer/lib" file="${hibernate.jdbc.jar}"/>
  </target>

  <target name="build-xml" depends="prepare">
    <jar destfile="build/hibernate/jar/${project.name}-hbm-xml.jar"
         basedir="project/hibernate/mappings" index="true"/>
  </target>

  <target name="mapping-files-check">
    <uptodate property="generated.code.up.to.date">
      <srcfiles dir="project/hibernate/mappings" includes="**/*.hbm.xml"/>
      <mapper type="glob" from="*.hbm.xml" to="${basedir}/build/hibernate/generated/*.java"/>
    </uptodate>
  </target>

  <target name="build-generated-code"
          unless="generated.code.up.to.date"
          depends="mapping-files-check, prepare">
    <pathconvert refid="hibernate.mapping.files"
                 property="hibernate.mappings" pathsep=" "/>
    <java classname="net.sf.hibernate.tool.hbm2java.CodeGenerator"
      fork="true">
      <arg line="--output=build/hibernate/generated ${hibernate.mappings}"/>
      <classpath>
        <path refid="lib.path" />
        <pathelement location="build/hibernate/final/classes" />
      </classpath>
    </java>
    <javac srcdir="build/hibernate/generated"
           destdir="build/hibernate/final/classes">
      <classpath>
        <path refid="lib.path"/>
        <pathelement location="build/hibernate/final/classes" />
      </classpath>
    </javac>
  </target>

  <target name="generate-schema" depends="build-generated-code"
          description="generates the database schema">
    <taskdef name="schemaexport"
             classname="net.sf.hibernate.tool.hbm2ddl.SchemaExportTask">
      <classpath>
        <path refid="lib.path"/>
        <pathelement path="build/hibernate/final/classes"/>
      </classpath>
    </taskdef>

    <schemaexport properties="project/hibernate/config/hibernate.properties"
                  quiet="${hibernate.schema.quiet}"
                  text="${hibernate.schema.text.only}"
                  drop="no" delimiter=";"
                  output="build/hibernate/schema/schema-export.sql">
      <fileset dir="project/hibernate/mappings">
        <include name="**/*.hbm.xml"/>
      </fileset>
    </schemaexport>
  </target>


  <target name="clean" description="Cleans all ant targets">
    <delete dir="build" />
    <delete dir="dist" />
  </target>

</project>
